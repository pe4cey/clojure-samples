<html>
<head>
    <title>Scatterplot</title>
    <link type="text/css" rel="stylesheet" href="ex.css?3.2"/>
    <script type="text/javascript" src="js/protovis.js"></script>
    <script src="http://code.jquery.com/jquery-latest.js"></script>

    <style type="text/css">
        #fig {
        width: 430px;
        height: 425px;
        }

    </style>
</head>
<body>
<div id="center">
    <div id="fig">
        <script type="text/javascript">
            var dataURL = "/code-changes-plain.json";
            var jsonData = $.ajax({ type: "GET", url: dataURL, async: false }).responseText;
            var commits = JSON.parse(jsonData);

            var startDate = new Date(commits[0].date);
            var endDate = new Date(commits[commits.length - 1].date);
            var numberOfDays = Math.ceil((endDate.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24))

            var goodDay = new Date(1990, 1, 1, 5, 0);
            var nextGoodDay = new Date(1990, 1, 1, 23, 0);

            var data = $.map(commits, function(commit) {
                var commitDate = new Date(commit.date);
                var minutes = new Date(goodDay);
                minutes.setHours(commitDate.getHours());
                minutes.setMinutes(commitDate.getMinutes());

                console.log(minutes);

                return {x: commitDate, y: minutes, z: commit.size, m: commit.message};
            });

            var dateFormat = pv.Format.date("%d/%B");
            var timeFormat = pv.Format.date("%H:%M");

        </script>
        <script type="text/javascript+protovis">
            /* Sizing and scales. */
            var w = 1600,
            h = 800,
            x = pv.Scale.linear(startDate, endDate).range(0, w),
            y = pv.Scale.linear(goodDay, nextGoodDay).range(0, h),
            c = pv.Scale.log(1, 100).range("orange", "brown"),
            sizeScale = pv.Scale.linear(1, 20000).range(1, 3000);

            /* The root panel. */
            var vis = new pv.Panel()
            .width(w)
            .height(h)
            .bottom(20)
            .left(30)
            .right(10)
            .top(5);

            /* Y-axis and ticks. */
            vis.add(pv.Rule)
            .data(y.ticks())
            .bottom(y)
            .strokeStyle(function(d) d ? "#eee" : "#000")
            .anchor("left").add(pv.Label)
            .text(function(val) {
                console.log(val);
                return timeFormat(val)
            });

            /* X-axis and ticks. */
            vis.add(pv.Rule)
            .data(x.ticks())
            .left(x)
            .strokeStyle(function(d) d ? "#eee" : "#000")
            .anchor("bottom").add(pv.Label)
            .text(function(val) dateFormat(val));

            /* The dot plot! */
            vis.add(pv.Panel)
            .data(data)
            .add(pv.Dot)
            .left(function(d) x(d.x))
            .bottom(function(d) y(d.y))
            .strokeStyle(function(d) c(d.z))
            .fillStyle(function() this.strokeStyle().alpha(.2))
            .size(function(d) sizeScale(d.z))
            .title(function(d) d.m);

            vis.render();
        </script>
    </div>
</div>
</body>
</html>